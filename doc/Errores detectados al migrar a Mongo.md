# Errores detectados al migrar a Mongo

Como todo software, este no está libre de problemas. Se listan a continuación errores detectados al migrar de la versión base de SQL a la versión Mongo que fueron corregidos:

1. Esto es un error de diseño por desconocimiento y es más una lección aprendida: El ID de una entidad debería haber sido de tipo `String` (con un hash auto generado) en la versión SQL. Esto habría simplificado la migración a Mongo dónde los IDs son de tipo `String`
2. Hay varios _endpoints_ (de test) que no estaban usando DTOs sino simplemente un mapa en donde existe un propiedad "ids", "cuits" o "codes". Había mucho código repetido para cargar dichos mapas. El uso de DTOs simplicó el controlador de test grandemente.
3. El método personalizado `findAllIds` de un repositorio SQL se puede eliminar (a costa de una posible pérdida de rendimiento que no medí). En vez de tener dicho método con una _query_ asociada para traer de la base sólo los campos necesarios (el _id_ en este caso), se puede usar el método estándar `findAll` desde el servicio asociado y mapear la colección obtenida para seleccionar solamente el campo de interés. Esto facilita la migración a Mongo ya que `findAllIds` tiene una query HQL que no es compatible con dicha base NoSQL.
4. Había muchas colecciones no inicializadas a una lista vacía en el constructor (como `Bank.cards`, `Card.purchases`, `CardHolder.cards`). El error no fue visible porque el código SQL (para generar datos) no requirió construir objetos vacíos, pero si el de Mongo.
5. El generador de datos no generaba bien las cuotas para compras de tipo `Cash`. siempre debería generar una única cuota, pero en ocaciones ajustaba el número de cuotas dependiendo del vencimiento (algo que se tiene que hacer para compras de tipo `Credit`, pero no para `Cash`). Problema corregido.
6. El generador de datos no estaba generando un valor aleatorio de tarjetas por usuario, sino el valor máximo fijado para el valor aleatorio. Ej: en vez de generar entre 1 y 3 tajetas, generaba directamente 3 tarjetas.
7. Se mejora el test `CardPurchasesControllerTests.testPurchasesCreditGetTotalPriceHappyPath` ya que el mismo tenía _hardcodeado_ un ID de compra a crédito. Ahora, mediante un nuevo _endpoint_ de prueba se busca una compra cualquiera a crédito para ser usada. El hecho de que los IDs en Mongo sean cadenas hash y no enteros auto numéricos generados, hace imposible tener un ID _hardcodeado_ ya que los mismos cambian en cada ejecución.
8. Se mejora/simplifica/extiende el test `CardPurchasesControllerTests.testStoresGetAvailblePromotions` (fue reemplazado por `testStoresGetAvailblePromotionsHappyPath` y `testStoresGetAvailblePromotionsNotFound`)
9. El código de una promoción no estaba marcado como de valor único.